<!DOCTYPE html>
<html>
	<head>
		<title>Scan all 12 QR codes</title>
		<script type="module">
            import nacl from './nacl-fast-es.js';

			const titleField = document.getElementById("TitleField")
			const statusField = document.getElementById("StatusField")
			const codeField = document.getElementById("CodeField")

			const isNotString = (value) => typeof value == "string";

			window.clearStorage = function() {
				localStorage.clear()
				window.location = window.location.pathname
			}

			function initMemory(numberOfParts){
				if (localStorage.codes == undefined){
					localStorage.codes = JSON.stringify(Array(numberOfParts));
				}
			}
			
			function setMemory(nr, value){
				let codes = JSON.parse(localStorage.codes)
				codes[nr] = value
				localStorage.codes = JSON.stringify(codes)
				console.log(localStorage.codes)
			}
			
			function getMemoryKeys(){
				let outText = []
				for (const code of getMemoryValues()){
					outText.push(isNotString(code)?"x":"_")
				}
				return "["+outText.join('|')+"]"
			}
			
			function getMemoryValues(){
				return JSON.parse(localStorage.codes)
			}
			
			function getSecret(box){
				const key = new Uint8Array(nacl.secretbox.keyLength);
                const nonce = new Uint8Array(nacl.secretbox.nonceLength);
                const msgOut = nacl.secretbox.open(box, nonce, key);
                return (new TextDecoder()).decode(msgOut)
			}		

			
            function fromHexString(hexString){
				return Uint8Array.from(hexString.match(/.{1,2}/g).map((byte) => parseInt(byte, 16)));
			}

			
			window.onload = function() {
				const queryString = window.location.search;
				const urlParams = new URLSearchParams(queryString)
				if (!urlParams.has('Tot') || !urlParams.has('Nr') || !urlParams.has('Code')){
					statusField.innerText = "Missing param Tot, Nr or Code";
					return;
				}
				const tot = Number(urlParams.get('Tot'))
				const nr = Number(urlParams.get('Nr'))
				const code = urlParams.get('Code') // Toido validate is hex

				titleField.innerText = "Scan all "+tot+" QR codes"

				console.log("Nr: "+nr+" Code: "+code);
        
				initMemory(tot)
				setMemory(nr, code)
				statusField.innerText = "Last scan "+(nr+1)+"\n"+getMemoryKeys()
				
				const codes = getMemoryValues()
				if (codes.every(isNotString)){
					const code = codes.join('')
					const bytes = fromHexString(code)
					const text = getSecret(bytes)
					codeField.innerText = text
				}
			}
		
		</script>
	</head>
	<body>
		<h1 id="TitleField">Scan all QR codes</h1>
		<div id="StatusField"></div>
		<div id="CodeField" style="font-size:300px"> </div>
		<br>
		<button onclick="clearStorage()">Clear</button>
	</body>
</html>
