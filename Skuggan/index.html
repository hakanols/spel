<!DOCTYPE html>
<html>
<head>
    <title>Sommarskuggan</title>
    <script type="module">
        const canvasWidth = 14;
        const canvasHeight = 8;
        const squarWidth = 100;
        const squarHeight = 100;
        const imageURL = "skuggan.svg"
        let devMode = false
        let skugg;
        const bricks = [
            [0,1,0,0,0,1,0,1,0,1,1,0,0,0],
            [0,1,0,1,0,0,0,1,0,1,0,0,1,0],
            [0,1,0,1,0,1,1,1,0,1,0,1,1,0],
            [0,0,0,1,0,1,0,0,0,1,0,1,0,0],
            [1,1,0,1,0,1,0,1,0,0,0,1,0,1],
            [0,0,0,1,0,1,0,1,0,1,0,1,0,0],
            [0,1,1,1,1,1,1,1,0,1,0,1,1,0],
            [0,0,0,0,0,0,0,0,0,1,0,0,1,0]
        ]

        function toggleDevMode(){
            devMode = !devMode;
            console.log('Developer mode: ' + devMode)
        }

        window.startGame = function() {
            const canvas = document.getElementById("canvas");
            const info = document.getElementById("info");
            info.addEventListener("click", toggleDevMode)
            canvas.width = canvasWidth*squarWidth;
            canvas.height = canvasHeight*squarHeight;

            const context = canvas.getContext("2d");
            context.imageSmoothingEnabled = false;
            skugg = new Image();
            skugg.onload = function() {
                update(0, 0, skugg)
            }
            skugg.src = imageURL;
            const brick = new Image();
            brick.onload = function() {
                 bricks.forEach( function (row, y){
                    row.forEach( function (item, x){
                        if (item == 1){       
                            draw(x, y, brick)
                        }
                      })
                  })
            }
            brick.src = "brick.svg";

            const livspuck = new Image();
            livspuck.onload = function() {
                draw(canvasWidth-1, canvasHeight-1, livspuck)
            }
            livspuck.src = "livspuck.svg";

            let currentX = 0
            let currentY = 1

            const update = function(newX, newY, img){
                console.log('X: '+newX+' Y: '+newY)
                if (0 <= newX && newX < canvasWidth && 
                    0 <= newY && newY < canvasHeight &&
                    bricks[newY][newX] == 0  ) {  
                    context.clearRect(currentX*squarWidth, currentY*squarHeight, squarWidth, squarHeight);
                    context.drawImage(img, newX*squarWidth, newY*squarHeight, squarWidth, squarHeight);
                    currentX = newX
                    currentY = newY
                }
            }

            function draw(newX, newY, img){
                context.drawImage(img, newX*squarWidth, newY*squarHeight, squarWidth, squarHeight);
            }

            function HandleMoveEvent(e){
                const rect = canvas.getBoundingClientRect();
                const canvasBoxWidth = (rect.right-rect.left)/canvasWidth
                const canvasBoxHeight = (rect.bottom-rect.top)/canvasHeight
                const x = (e.pageX-rect.left)/canvasBoxWidth
                const y = (e.pageY-rect.top)/canvasBoxHeight
                if (devMode) {
                    update(Math.floor(x), Math.floor(y), skugg)
                    return
                }
                
                const diffX = x-(currentX+0.5)
                const diffY = y-(currentY+0.5)
                const overTiltPlusOne = diffY > diffX
                const overTiltMinusOne = diffY > -diffX

                if (overTiltPlusOne && overTiltMinusOne) {
                    console.log('Down')
                    update(currentX, currentY+1, skugg)
                }
                else if (!overTiltPlusOne && overTiltMinusOne){
                    console.log('Rigth')
                    update(currentX+1, currentY, skugg)
                }
                else if (overTiltPlusOne && !overTiltMinusOne){
                    console.log('Left')
                    update(currentX-1, currentY, skugg)
                }
                else {
                    console.log('Up')
                    update(currentX, currentY-1, skugg)
                }
            }
            canvas.addEventListener('mousedown', HandleMoveEvent) // 'mouseup'
            canvas.addEventListener('touchstart', HandleMoveEvent) // 'touchend'
            window.addEventListener('keyup', (event) => {
                switch (event.key) {
                    case 'ArrowLeft':
                        update(currentX-1, currentY, skugg)
                        break;
                    case 'ArrowRight':
                        update(currentX+1, currentY, skugg)
                        break;
                    case 'ArrowUp':
                        update(currentX, currentY-1, skugg)
                        break;
                    case 'ArrowDown':
                        update(currentX, currentY+1, skugg)
                        break;
                    case 'h':
                        toggleDevMode()
                        break;
                    default:
                        console.log('Only Arrow Keys Are Allowed! ' + event.key)
                }
            });
        }
    </script>
</head>
<body onload="startGame()">
    <div style="width: 100vw; height: 66vw; 
    max-height: 100vh; max-width: 150vh; margin: auto;
    position: absolute; top:0;bottom:0; left:0;right:0;">
        <br>
        <canvas id="canvas" style="width:100%; aspect-ratio:7/4;border:4px solid #000000;"></canvas>
        <p id="info">Move Sommarskuggan with your finger, mouse or arrow keys.</p>
    </div>
</body>
</html>