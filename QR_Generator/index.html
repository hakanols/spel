<html>
	<head>
		<title>QR Generator</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<script type="module">
			import QRCode from './qrcode.js'

			// String formatting found here: https://github.com/zxing/zxing/wiki/Barcode-Contents 
			// and here https://developer.swish.nu/documentation/guides/generate-qr-codes
			
			const outputArea = document.getElementById("outputArea");
			const ssidElement = document.getElementById("ssid");
			const passwordElement = document.getElementById("password");
			const smsNumberElement = document.getElementById("smsNumber");
			const smsTextElement = document.getElementById("smsText");
			const emailAddressElement = document.getElementById("emailAddress");
			const emailSubjectElement = document.getElementById("emailSubject");
			const emailTextElement = document.getElementById("emailText");
			const urlElement = document.getElementById("url");
			const swishNumberElement = document.getElementById("swishNumber");
			const swishAmountElement = document.getElementById("swishAmount");
			const swishAmountOkElement = document.getElementById("swishAmountOk");
			const swishMsgElement = document.getElementById("swishMsg");
			const swishMsgOkElement = document.getElementById("swishMsgOk");
			const wifiRadioElement = document.getElementById("radioWifi");
			const smsRadioElement = document.getElementById("radioSms");
			const emailRadioElement = document.getElementById("radioEmail");
			const urlRadioElement = document.getElementById("radioUrl");
			const swishRadioElement = document.getElementById("radioSwish");
			const correctionElement = document.getElementById("correctionLevel");
			const dataTypeElement = document.getElementById("dataType");

			function createWiFiMessage(ssid, password){
				const security = "WPA" // <WPA|WEP|>
				return "WIFI:S:"+ssid+";T:"+security+";P:"+password+";;";
			}

			function createSmsMessage(number, text){
				return "SMSTO:"+number+":"+text;
			}

			function createEmailMessage(address, subject, text){
				return "MATMSG:TO:"+address+";SUB:"+subject+";BODY:"+text+";;";
			}

			function createSwishMessage(number, amount, amountOk, msg, msgOk){
				let swishMessage = "https://app.swish.nu/1/p/sw/?sw="+number
				if (amount != "") swishMessage += "&amt="+amount
				if (msg != "") swishMessage += "&msg="+msg
				if (!amountOk && !msgOk)
					swishMessage += "&edit=amt,msg"
				else if (!amountOk)
					swishMessage += "&edit=amt"
				else if (!msgOk)
					swishMessage += "&edit=msg"

				return swishMessage
			}

			async function setQRcode(content, correctionLevel ){
				let qrCode = new QRCode({ content: content, join: true, ecl: correctionLevel });
				const blob = new Blob([qrCode.svg()], { type: "image/svg+xml" });
				const url = URL.createObjectURL(blob);
				outputArea.src = url;
			}

			function clearQRcode(){
				outputArea.src = "";
			}

			function getContent() {
				if (wifiRadioElement.checked){
					return createWiFiMessage(ssidElement.value, passwordElement.value)
				}
				else if (smsRadioElement.checked){
					if (!smsNumberElement.checkValidity()) return;
					return createSmsMessage(smsNumberElement.value, smsTextElement.value)
				}
				else if (emailRadioElement.checked){
					if (!emailAddressElement.checkValidity()) return;
					return createEmailMessage(emailAddressElement.value, emailSubjectElement.value, emailTextElement.value)
				}
				else if (urlRadioElement.checked){
					return urlElement.value
				}
				else if (swishRadioElement.checked){
					if (!swishNumberElement.checkValidity()) return;
					if (!swishAmountElement.checkValidity()) return;
					return createSwishMessage(swishNumberElement.value, swishAmountElement.value, swishAmountOkElement.checked, swishMsgElement.value, swishMsgOkElement.checked)
				}
			}

			window.checkUrl = async function(){
				try {
					dataTypeElement.innerText = (new URL(urlElement.value)).protocol
				} catch (_) {
					dataTypeElement.innerText = "Free text"
				}
				window.update()
			}

			window.update = async function(){
				let content = getContent()
				console.log(content)
				if (content == "" || content == null){
					clearQRcode()
				}
				else {
					setQRcode(content, correctionElement.value);
				}
			}

			window.checkUrl();

		</script>
		<style>
			input:invalid{background-color: #ffdddd;}
			div.ruta{
				padding:10px; 
				background-color: white;
				border:5px solid gray;
				margin:10px;
				border-radius: 10px 10px 10px 10px;
				box-shadow: 4px 4px 2px 2px black;
				font-family: Noteworthy;
			}
		</style>
	</head>
	<body style="background-image: url('agave.jpg'); background-repeat: no-repeat; background-attachment: fixed; background-size: cover; background-position: center center;">
		<div class="ruta" style="width:400px;margin-right:auto;margin-left:auto;">

			<h1 style="text-align: center">QR Generator</h1>

			<table>
				<tbody>
					<tr>
						<td valign="top">
							<input id="radioWifi" name="qrType" checked="checked" onclick="update();" type="radio">
						</td> <td rowspan="1" colspan="2" width="100%" valign="top">
							WiFi login
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td valign="top">
							SSID:
						</td><td valign="top">
							<input style="width:100%;" id="ssid" oninput="update()" type="text">
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td valign="top">
							Password:
						</td><td width="100%" valign="top">
							<input style="width:100%" id="password" oninput="update()" type="text">
						</td>
					</tr><tr>
						<td valign="top"><br></td>
					</tr> <tr>
						<td valign="top">
							<input id="radioSms" name="qrType" onclick="update();" type="radio">
						</td> <td rowspan="1" colspan="2" width="100%" valign="top">
							SMS
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td valign="top">
							Number:
						</td><td valign="top">
							<input style="width:100%;" id="smsNumber" oninput="update()" type="number" required>
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td valign="top">
							Text:
						</td><td width="100%" valign="top">
							<input style="width:100%" id="smsText" oninput="update()" type="text">
						</td>
					</tr><tr>
						<td valign="top"><br></td>
							</tr> <tr>
						<td valign="top">
							<input id="radioEmail" name="qrType" onclick="update();" type="radio">
						</td> <td rowspan="1" colspan="2" width="100%" valign="top">
							Email
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td valign="top">
							Address:
						</td><td valign="top">
							<input style="width:100%" id="emailAddress" oninput="update()" type="email" required>
						</td>
					</tr><tr>	
						<td valign="top"><br></td>
						<td valign="top">
							Subject:
						</td><td width="100%" valign="top">
							<input style="width:100%" id="emailSubject" oninput="update()" type="text">
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td valign="top">
							Text:
						</td><td width="100%" valign="top">
							<input style="width:100%" id="emailText" oninput="update()" type="text">
						</td>
					</tr><tr>
						<td valign="top"><br></td>
					</tr> <tr>
						<td valign="top">
							<input id="radioUrl" name="qrType" onclick="update();" type="radio">
						</td> <td rowspan="1" colspan="2" valign="top">
							Url or free text: (<label id="dataType"></label>)
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td rowspan="1" colspan="2" valign="top">
							<input style="width:100%;" id="url" oninput="checkUrl()" type="text">
						</td>
					</tr>
						<td valign="top"><br></td>
					</tr> <tr>
						<td valign="top">
							<input id="radioSwish" name="qrType" onclick="update();" type="radio">
						</td> <td rowspan="1" colspan="2" valign="top">
							Swish
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td valign="top">
							Number:
						</td><td width="100%" valign="top">
							<input style="width:100%" id="swishNumber" oninput="update()" type="number" required>
						</td><td valign="top">
							üîê
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td valign="top">
							Amount:
						</td><td width="100%" valign="top">
							<input style="width:100%" id="swishAmount" oninput="update()" type="number">
						</td><td valign="top">
							<input id="swishAmountOk" oninput="update()" type="checkbox">
						</td>
					</tr><tr>
						<td valign="top"><br></td>
						<td valign="top">
							Message:
						</td><td width="100%" valign="top">
							<input style="width:100%" id="swishMsg" oninput="update()" type="text">
						</td><td valign="top">
							<input id="swishMsgOk" oninput="update()" type="checkbox">
						</td>
					</tr>
				</tbody>
			</table>

			<p>Correction level:
				<select id="correctionLevel" onchange="update();">
					<option value="L">Low</option>
					<option value="M" selected="selected">Medium</option>
					<option value="H">High</option>
				</select>
			</p>
			<img id="outputArea" style="display: block;	margin-left: auto; margin-right: auto; width: 66%;"></img>
		</div>
	</body>
</html>
