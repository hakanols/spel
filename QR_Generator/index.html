<html>
	<head>
		<title>WiFi QR code</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<script type="module">
			import * as QRCode from './qrcode-lite.js'

			// String formating found here: https://github.com/zxing/zxing/wiki/Barcode-Contents 
			
			const qrCodeElement = document.getElementById("qrcode");
			const ssidElement = document.getElementById("ssid");
			const passwordElement = document.getElementById("password");
			const urlElement = document.getElementById("url");		
			const wifiRadioElement = document.getElementById("radioWifi");
			const urlRadioElement = document.getElementById("radioUrl");
			const correctionElement = document.getElementById("correctionLevel");
			const dataTypeElement = document.getElementById("dataType");

			function getCorrectionLevel(){
				return {
					errorCorrectionLevel: correctionElement.value
				}
			}

			function createWiFiMessage(ssid, password){
				const security = "WPA" // <WPA|WEP|>
				return "WIFI:S:"+ssid+";T:"+security+";P:"+password+";;";
			}

			async function setQRcode(content, options){
				await QRCode.toCanvas(qrCodeElement, content, options);
			}

			function clearQRcode(){
				var ctx = qrCodeElement.getContext("2d");
				ctx.clearRect(0, 0, qrCodeElement.width, qrCodeElement.height);
				ctx.beginPath();
			}

			window.checkUrl = async function(){
				try {
					dataTypeElement.innerText = (new URL(urlElement.value)).protocol
				} catch (_) {
					dataTypeElement.innerText = "Free text"
				}
				window.updateCount()
			}

			window.updateCount = async function(){
				let content
				if (wifiRadioElement.checked){
					content = createWiFiMessage(ssidElement.value, passwordElement.value)
				}
				else if (urlRadioElement.checked){
					content = urlElement.value
				}
				console.log(content)
				if (content == ""){
					clearQRcode()
				}
				else {
					await setQRcode(content, getCorrectionLevel());
				}
			}

			window.checkUrl();

		</script>
	</head>
	<body style="background-image: url('agave.jpg'); background-repeat: no-repeat; background-attachment: fixed; background-size: cover; background-position: center center;">
		<h1>QR Generator</h1>

		<table width="500px">
			<tbody>
				<tr>
					<td valign="top">
						<input id="radioWifi" name="qrType" checked="checked" onclick="updateCount();" type="radio">
					</td> <td rowspan="1" colspan="2" width="100%" valign="top">
						WiFi login
					</td>
				</tr><tr>
					<td valign="top"><br></td>
					<td valign="top">
						SSID:
					</td><td valign="top">
						<input style="width:100%;" id="ssid" oninput="updateCount()" type="text">
					</td>
				</tr><tr>
					<td valign="top"><br></td>
					<td valign="top">
						Password:
					</td><td width="100%" valign="top">
						<input style="width:100%" id="password" oninput="updateCount()" type="text">
					</td>
				</tr><tr>
					<td valign="top"><br></td>
				</tr> <tr>
					<td valign="top">
						<input id="radioUrl" name="qrType" onclick="updateCount();" type="radio">
					</td> <td rowspan="1" colspan="2" valign="top">
						Url or free text: (<label id="dataType"></label>)
					</td>
				</tr><tr>
					<td valign="top"><br></td>
					<td rowspan="1" colspan="2" valign="top">
						<input style="width:100%;" id="url" oninput="checkUrl()" type="text">
					</td>
				</tr>
			</tbody>
		</table>

		<p>Correction level:
			<select id="correctionLevel" onchange="updateCount();">
				<option value="L">Low</option>
				<option value="M" selected="selected">Medium</option>
				<option value="H">High</option>
			</select>
		</p>
		<br>
		<canvas id="qrcode"></canvas>
	</body>
</html>
