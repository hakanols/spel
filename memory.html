<!DOCTYPE html>
<html>
	<head>
		<title>Taurus Labyrint</title>
		<script type="module">
			const images = ["Kugg1.png", "Kugg2.png", "D.png", "H.png", "M.png", "O.png", "P.png", "T.png"]
			const random = createRandom()
			const peekTime = 10
			const graceTime = 2;
			const life = 6
			let lastElement = null
			let active = false;
			let donePaires = 0;
			let killLife;

			function done(success){
				const trophy = document.getElementById("Trophy")
				let img = document.createElement("img");
				if (success){
					img.src = "pokal.svg";
				}
				else {
					img.src = "Slime.png";
				}
				img.style = "height:300px;width:280px"
				trophy.appendChild(document.createElement("br"))
				trophy.appendChild(img);
			}

			async function handleClick(element, index){
				if (!active){
					console.log("Ignore")
					return
				}
				if (element.style.background != ""){
					console.log("Ignore")
					return
				}
				console.log(index)
				element.children[0].src = images[random[index]]
				if (lastElement == null){
					lastElement = element
					element.style.background = "blue";
				}
				else {
					if (element.innerHTML == lastElement.innerHTML) {
						element.style.background = "green";
						lastElement.style.background = "green";
						donePaires = donePaires + 1;
						if (donePaires==8){
							done(true)
						}
					}
					else {
						active = false
						if (!killLife()){
							done(false)
							return
						}
						element.style.background = "blue";
						await sleep(graceTime*1000)
						element.style.background = "";
						lastElement.style.background = "";
						element.children[0].src = "Quest.png"
						lastElement.children[0].src = "Quest.png"
						active = true
					}
					lastElement = null
				}
			}

			function sleep(ms) {
				return new Promise(resolve => setTimeout(resolve, ms));
			}

			function createRandom(){
				let items = Array(...Array(8).keys(), ...Array(8).keys() )
				for (var i = 0; i < 16; i++) {
					const random = Math.floor(Math.random() * 16)
					let temp = items[i];
					items[i] = items[random]
					items[random] = temp
				}
				return items
			}

			function popLife (number=1){
				let index = 0
				let life = document.getElementById("Life")
				for (let index = 0; index < number; index++) {
					let img = document.createElement("img");
					img.src = "Livspuck.png";
					img.style = "height:60px;width:60px"
					life.appendChild(img);
				}
				return function(){
					if (index >= number){
						return false
					}
					life.children[index].src = "Deadpuck.png"
					index++;
					return index < number
				}
			}

			function populate(){
				const buttons = document.getElementById("Buttons")
				let elements = []
				for (let index = 0; index < 16; index++) {
					let btn = document.createElement("button");
					let img = document.createElement("img");
					img.src = images[random[index]];
					img.style = "height:80px;width:80px"
					btn.appendChild(img);
					elements.push(img)
					btn.onclick = function() {
						handleClick(btn, index)
					}
					buttons.appendChild(btn);


					if ((index+1) % 4 == 0) {
						buttons.appendChild(document.createElement("br"))
					}
				}
				return elements
			}

			window.onload = async function() {
				killLife = popLife(life)
				const elements = populate()
				const time = document.getElementById("Time")
				for (let secLeft = peekTime; secLeft >= 0; secLeft--) {
					time.innerText = secLeft
					await sleep(1000)
				}
				time.innerText = ''
				for (let element of elements){
					element.src = "Quest.png"
				}
				active = true
				console.log('Game on')
			}	
		</script>
	</head>
	<body style="background-color: #21455d">
		<h1>Taurus Labyrint</h1>
		<button onclick="location.reload()" style="height:40px;width:320px">Hejduk</button>
		<br><br>
		<div id="Life"></div>
		<div id="Time"></div>
		<div id="Buttons"></div>
		<div id="Trophy"></div>
		<p>av: Hjalmar och HÃ¥kan</p>
	</body>
</html>
