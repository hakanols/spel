<!DOCTYPE html>
<html>
<head>
    <title>Sommarskuggan</title>
    <script type="module">
        const canvasWidth = 14;
        const canvasHeight = 8;
        const squarWidth = 100;
        const squarHeight = 100;
        const imageURL = "skuggan.svg"
        let devMode = false
        const bricks = [
            [0,1,0,0,0,1,0,1,0,1,1,0,0,3],
            [0,1,0,1,0,0,0,1,0,1,0,0,1,0],
            [0,1,0,1,0,1,1,1,0,1,0,1,1,0],
            [0,0,0,1,0,1,0,0,0,1,0,1,0,0],
            [1,1,0,1,0,1,0,1,0,0,0,1,0,1],
            [0,0,0,1,0,1,0,1,0,1,0,1,0,0],
            [0,1,1,1,1,1,1,1,0,1,0,1,1,0],
            [0,0,0,0,0,0,0,0,0,1,0,0,1,2]
        ]

        function toggleDevMode(){
            devMode = !devMode;
            console.log('Developer mode: ' + devMode)
        }

        async function loadImage(source){
            const img = new Image();
            img.src = source;
            await img.decode();
            return img;
        };

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }

        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        window.startGame = async function() {
            const canvas = document.getElementById("canvas");
            const info = document.getElementById("info");
            
            info.addEventListener("click", toggleDevMode)
            canvas.width = canvasWidth*squarWidth;
            canvas.height = canvasHeight*squarHeight;

            const context = canvas.getContext("2d");
            context.imageSmoothingEnabled = false;

            const skuggan = await loadImage(imageURL);
            const brick = await loadImage("brick.svg");
            const livspuck = await loadImage("livspuck.svg");
            const fire = [
                await loadImage("fire1.svg"),
                await loadImage("fire2.svg"),
                await loadImage("fire3.svg"),
                await loadImage("fire4.svg"),
                await loadImage("fire5.svg"),
                await loadImage("fire6.svg"),
            ];

            let currentX = 0
            let currentY = 1

            function updateSkuggan(newX, newY){
                console.log('X: '+newX+' Y: '+newY)
                if (0 <= newX && newX < canvasWidth && 
                    0 <= newY && newY < canvasHeight &&
                    bricks[newY][newX] == 0  ) {  
                    clear(currentX, currentY);
                    draw(newX, newY, skuggan);
                    currentX = newX
                    currentY = newY
                }
            }

            async function runGuiFire(){
                while (true){
                    let newFires = [];
                    bricks.forEach( function (row, y){
                        row.forEach( function (item, x){
                            if (item == 3 || item == 4){     
                                let index = Math.floor(Math.random() * fire.length)
                                clear(x, y)
                                draw(x, y, fire[index]);
                            }
                        })
                    })
                    await sleep(500)
                }
            }

            async function runUpdateFire(){
                while (true){
                    let newFires = [];
                    bricks.forEach( function (row, y){
                        row.forEach( function (item, x){
                           if (item == 3){ 
                                newFires.push([x-1, y], [x+1, y], [x, y-1], [x, y+1])
                                row[x] = 4
                            }
                        })
                    })
                    for (const[x, y] of newFires){
                        if (0 <= x && x < canvasWidth && 
                            0 <= y && y < canvasHeight &&
                            bricks[y][x] == 0  ) 
                        {  
                            bricks[y][x] = 3;
                        }
                    }
                    await sleep(2000)
                }
            }

            function clear(newX, newY){
                context.clearRect(newX*squarWidth, newY*squarHeight, squarWidth, squarHeight);
            }

            function draw(newX, newY, img){
                context.drawImage(img, newX*squarWidth, newY*squarHeight, squarWidth, squarHeight);
            }

            bricks.forEach( function (row, y){
                row.forEach( function (item, x){
                    if (item == 1){       
                        draw(x, y, brick)
                    }
                    else if (item == 2){       
                        draw(x, y, livspuck)
                    }
                })
            })
            runGuiFire()
            runUpdateFire()
            updateSkuggan(0, 0,)

            function HandleMoveEvent(e){
                const rect = canvas.getBoundingClientRect();
                const canvasBoxWidth = (rect.right-rect.left)/canvasWidth
                const canvasBoxHeight = (rect.bottom-rect.top)/canvasHeight
                const x = (e.pageX-rect.left)/canvasBoxWidth
                const y = (e.pageY-rect.top)/canvasBoxHeight
                if (devMode) {
                    updateSkuggan(Math.floor(x), Math.floor(y))
                    return
                }
                
                const diffX = x-(currentX+0.5)
                const diffY = y-(currentY+0.5)
                const overTiltPlusOne = diffY > diffX
                const overTiltMinusOne = diffY > -diffX

                if (overTiltPlusOne && overTiltMinusOne) {
                    console.log('Down')
                    updateSkuggan(currentX, currentY+1)
                }
                else if (!overTiltPlusOne && overTiltMinusOne){
                    console.log('Rigth')
                    updateSkuggan(currentX+1, currentY)
                }
                else if (overTiltPlusOne && !overTiltMinusOne){
                    console.log('Left')
                    updateSkuggan(currentX-1, currentY)
                }
                else {
                    console.log('Up')
                    updateSkuggan(currentX, currentY-1)
                }
            }
            canvas.addEventListener('mousedown', HandleMoveEvent) // 'mouseup'
            canvas.addEventListener('touchstart', HandleMoveEvent) // 'touchend'
            window.addEventListener('keyup', (event) => {
                switch (event.key) {
                    case 'ArrowLeft':
                        updateSkuggan(currentX-1, currentY)
                        break;
                    case 'ArrowRight':
                        updateSkuggan(currentX+1, currentY)
                        break;
                    case 'ArrowUp':
                        updateSkuggan(currentX, currentY-1)
                        break;
                    case 'ArrowDown':
                        updateSkuggan(currentX, currentY+1)
                        break;
                    case 'h':
                        toggleDevMode()
                        break;
                    case ' ':
                        toggleFullScreen()
                        break;

                    default:
                        console.log('Only Arrow Keys Are Allowed! ' + event.key)
                }
            });
        }
    </script>
</head>
<body onload="startGame()">
    <div style="width: 100vw; height: 66vw; 
    max-height: 100vh; max-width: 150vh; margin: auto;
    position: absolute; top:0;bottom:0; left:0;right:0;">
        <br>
        <canvas id="canvas" style="width:100%; aspect-ratio:7/4;border:4px solid #000000;"></canvas>
        <p id="info">Move Sommarskuggan with your finger, mouse or arrow keys.</p>
    </div>
</body>
</html>