<!DOCTYPE html>
<html>
	<head>
		<title>Scan all 12 QR codes</title>
		<script type="module">
			const titleField = document.getElementById("TitleField")
			const statusField = document.getElementById("StatusField")
			const codeField = document.getElementById("CodeField")

			window.clearStorage = function() {
				localStorage.clear()
				window.location = window.location.pathname
			}

			function initMemory(numberOfParts){
				if (localStorage.codes == undefined){
					localStorage.codes = JSON.stringify(Array(numberOfParts));
				}
			}
			
			function setMemory(nr, value){
				let codes = JSON.parse(localStorage.codes)
				codes[nr] = value
				localStorage.codes = JSON.stringify(codes)
			}
			
			function getMemoryKeys(){
				const codes = JSON.parse(localStorage.codes)
				let outText = []
				for (const code of codes){
					outText.push(code==null?"_":"x")
				}
				return "["+outText.join('|')+"]"
			}
			
			function getMemoryValues(){
				return JSON.parse(localStorage.codes).filter(Number) 
			}
			
			function pseudoRandom(seed) {
				return seed * 16807 % 2147483647 // https://javascript.info/task/pseudo-random-generator
			}
			
			function validCode(nr, code){
				let check = pseudoRandom(nr) % 100
				console.log("Check number: "+check)
				return check == code % 100
			}
			
			
			window.onload = function() {
				const queryString = window.location.search;
				const urlParams = new URLSearchParams(queryString)
				if (!urlParams.has('Tot') || !urlParams.has('Nr') || !urlParams.has('Code')){
					statusField.innerText = "Missing param Tot, Nr or Code";
					return;
				}
				const tot = Number(urlParams.get('Tot'))
				const nr = Number(urlParams.get('Nr'))
				const code = Number(urlParams.get('Code'))

				titleField.innerText = "Scan all "+tot+" QR codes"

				console.log("Nr: "+nr+" Code: "+code);
				if (!validCode(nr, code)){
					statusField.innerText= "Code is not valid";
					return;
				}
        
				initMemory(tot)
				setMemory(nr, code)
				statusField.innerText = "Last scan "+(nr+1)+"\n"+getMemoryKeys()
				
				let codes = getMemoryValues()
				if (codes.length == tot){
					let sum = 0;
					for (let code of codes){
						sum += code
					}
					console.log(sum)
					codeField.innerText = sum % 13
				}
			}
		
		</script>
	</head>
	<body>
		<h1 id="TitleField">Scan all QR codes</h1>
		<div id="StatusField"></div>
		<div id="CodeField" style="font-size:300px"> </div>
		<br>
		<button onclick="clearStorage()">Clear</button>
	</body>
</html>
